#!/usr/bin/env bash
set -euo pipefail

BAZEL_VERSION="$(bazel version |
  grep -Po '(?<=Build label: ).*'
)"

case "$BAZEL_VERSION" in
  3.*|4.*|5.*)
    DUMP_OPT="detailed"
    export SKYSCOPE_LEGACY_BAZEL="1"
    ;;
  *)
    DUMP_OPT="deps"
    ;;
esac

# Dump Skyframe graph and pipe it to Skyscope.
SKYSCOPE_DIR="${BASH_SOURCE[0]%/bin/skyscope}"
bazel dump --skyframe=$DUMP_OPT | nix-shell --run "
    cd '$SKYSCOPE_DIR'
    bazel run //backend:skyscope -- +RTS -N -RTS
" "$SKYSCOPE_DIR/shell.nix"
